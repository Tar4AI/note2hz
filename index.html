<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<meta name="theme-color" content="#0a0f1a"/>
<title>Note → Hz · v3.0 (A0–C8 · slide)</title>
<style>
  :root{
    --bg1:#0b1220; --bg2:#0a1120; --bg3:#0a0f1a;
    --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --accent:#10b981; --accent2:#22d3ee;
    --cellW: 60px;
    --whiteH: 210px;
    --blackScale: .62;
  }
  *{box-sizing:border-box}
  html{background:#0a0f1a}
  body{
    margin:0; color:var(--text);
    background-color:#0a0f1a;
    background-image: radial-gradient(1200px 600px at 50% -10%, var(--bg1) 0%, var(--bg2) 35%, var(--bg3) 100%);
    background-repeat:no-repeat; background-attachment:fixed;
    min-height:100dvh;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Thai", "Noto Sans", Arial;
    -webkit-user-select:none; user-select:none; touch-action:manipulation;
  }
  .wrap{
    max-width:1100px; margin:0 auto; padding:16px;
    padding-left:max(16px, env(safe-area-inset-left));
    padding-right:max(16px, env(safe-area-inset-right));
    padding-top:max(16px, env(safe-area-inset-top));
    padding-bottom:max(16px, env(safe-area-inset-bottom));
  }
  h1{font-size:clamp(18px,2vw,24px); font-weight:600; margin:0 0 12px}
  .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  .controls{gap:16px}
  .controls label{display:flex; gap:8px; align-items:center; font-size:14px; cursor:pointer}
  /* ให้โหมดเสียง + Pink Noise ชิดบรรทัดเดียวกันเสมอ */
  .modeRow{display:flex; gap:8px; align-items:center; flex-wrap:nowrap; white-space:nowrap}

  .card{background:linear-gradient(180deg, rgba(17,24,39,.7), rgba(15,23,42,.7)); border:1px solid #1f2937; border-radius:16px; padding:16px; box-shadow:0 8px 28px rgba(0,0,0,.35)}
  .card + .card{margin-top:16px}
  .label{font-size:12px; color:var(--muted); margin-bottom:6px}
  .value{font-size:clamp(18px,2.6vw,22px); font-weight:700; font-variant-numeric:tabular-nums}
  .big{font-size:clamp(26px,4vw,34px); font-weight:800; font-variant-numeric:tabular-nums}
  .small{font-size:12px; color:var(--muted)}

  input[type="checkbox"], input[type="range"], select{accent-color:var(--accent)}
  select{background:#111827; color:#e5e7eb; border:1px solid #374151; border-radius:10px; padding:6px 10px}

  .btn{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:10px; border:1px solid #334155; background:rgba(17,24,39,.6); color:#e5e7eb; cursor:pointer; transition:.15s}
  .btn:hover{transform:translateY(-1px); border-color:#475569}
  .btn.on{border-color:var(--accent2); box-shadow:0 0 0 2px rgba(34,211,238,.15); color:#cffafe}

  .grid4{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:12px; margin-top:12px}
  .box{display:flex; flex-direction:column; justify-content:center; border:1px solid #334155; background:rgba(30,41,59,.6); border-radius:12px; padding:10px 12px}
  .box .value{display:block}

  .keyboard{
    position:relative; overflow-x:auto; padding:12px; border-radius:12px;
    background:rgba(0,0,0,.15);
    -webkit-overflow-scrolling:touch;
    cursor:grab;
  }
  .keyboard:active{cursor:grabbing}
  .keys{display:flex; gap:0; scroll-snap-type:x proximity}
  .oct{scroll-snap-align:center; display:flex}
  .cell{position:relative; width:var(--cellW)}
  .white{
    position:relative; width:100%; height:var(--whiteH); background:#fff; color:#111;
    border:1px solid #4b5563; border-top:none; border-radius:0 0 8px 8px; box-shadow:0 4px 8px rgba(0,0,0,.35)
  }
  .white:active{transform:translateY(1px)}
  .wlab{position:absolute; bottom:8px; left:0; right:0; text-align:center; font-size:11px; color:#334155}
  .black{
    position:absolute; top:0; left:100%; transform:translateX(-50%);
    width:calc(var(--cellW)*.55); height:calc(var(--whiteH)*var(--blackScale));
    background:#000; color:#fff; border:1px solid #334155; border-top:none; border-radius:0 0 6px 6px; box-shadow:0 6px 12px rgba(0,0,0,.5); z-index:2
  }
  .black:active{transform:translateX(-50%) translateY(1px)}
  .blab{position:absolute; bottom:8px; left:0; right:0; text-align:center; font-size:10px; color:#e5e7eb}

  /* มือถือแนวนอน */
  @media (max-width: 920px) and (orientation:landscape){
    :root{ --cellW: clamp(44px, 6.8vw, 64px); --whiteH: clamp(180px, 45vh, 260px); }
    .grid4{ gap:8px }
    .box{ padding:8px 10px }
    .label{ font-size:11px }
    .value{ font-size:clamp(16px,2.2vw,20px) }
    h1{ font-size:clamp(16px,2.2vw,20px) }
    /* กันโหมดเสียง + pink noise แตกบรรทัด */
    .modeRow{gap:6px}
  }

  /* กล่อง 4 ช่องให้เตี้ยพอดีข้อความ */
  #row4{ min-height:0; }
  #row4 .box{ padding:6px 10px; }
  #row4 .label{ margin-bottom:2px; }
  #row4 .value{ line-height:1.15; }
</style>
</head>
<body>
  <div class="wrap">
    <header class="row" style="justify-content:space-between">
      <h1>Note → Hz · v3.0</h1>
      <div class="row controls">
        <label><input type="checkbox" id="toggleHarm" checked> แสดง Harmonics 2–4</label>
        <label><input type="checkbox" id="toggleSub" checked> แสดง Subharmonic 1/2</label>
        <label><input type="checkbox" id="togglePlay" checked> เล่นเสียงเมื่อกด</label>

        <!-- รวมโหมดเสียง + Pink Noise ไว้บรรทัดเดียวกัน -->
        <div class="modeRow">
          <label class="row" style="gap:8px; white-space:nowrap">โหมดเสียง
            <select id="oscType">
              <option value="sine" selected>Sine</option>
              <option value="square">Square</option>
              <option value="sawtooth">Saw</option>
              <option value="triangle">Triangle</option>
              <option value="feedback">Feedback</option>
            </select>
          </label>
          <button id="pinkBtn" class="btn" aria-pressed="false">Pink Noise</button>
        </div>
      </div>
    </header>

    <section class="card">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div>
          <div class="label">โน้ตที่เลือก</div>
          <div class="big" id="noteOut">—</div>
        </div>
        <div>
          <div class="label">ความถี่</div>
          <div class="big" id="hzOut">—</div>
        </div>
        <div class="row">
          <span class="small">โวลุ่ม</span>
          <input type="range" id="vol" min="0" max="1" step="0.01" value="0.5" style="width:200px">
        </div>
      </div>

      <div id="row4" class="grid4">
        <div class="box"><div class="label">Subharmonic × 1/2</div><div id="val-sub" class="value">—</div></div>
        <div class="box"><div class="label">Harmonic ×2</div><div id="val-h2" class="value">—</div></div>
        <div class="box"><div class="label">Harmonic ×3</div><div id="val-h3" class="value">—</div></div>
        <div class="box"><div class="label">Harmonic ×4</div><div id="val-h4" class="value">—</div></div>
      </div>
    </section>

    <section class="card">
      <div class="keyboard">
        <div id="keys" class="keys"></div>
      </div>
    </section>
  </div>

<script>
(() => {
  // ---------- utils ----------
  const noteOut = document.getElementById('noteOut');
  const hzOut = document.getElementById('hzOut');
  const vol = document.getElementById('vol');
  const toggleHarm = document.getElementById('toggleHarm');
  const toggleSub = document.getElementById('toggleSub');
  const togglePlay = document.getElementById('togglePlay');
  const oscTypeSel = document.getElementById('oscType');
  const keysWrap = document.getElementById('keys');
  const pinkBtn = document.getElementById('pinkBtn');

  const valSub = document.getElementById('val-sub');
  const valH2 = document.getElementById('val-h2');
  const valH3 = document.getElementById('val-h3');
  const valH4 = document.getElementById('val-h4');

  const sharpOf = { C:"C#", D:"D#", F:"F#", G:"G#", A:"A#" };
  const hasBlack = { C:true, D:true, E:false, F:true, G:true, A:true, B:false };

  const fmtHz = x => (x>=1000 ? (x/1000).toFixed(3)+' kHz' : x.toFixed(2)+' Hz');

  function noteToMidi(note){
    const m = note.match(/^([A-Ga-g])([#b]?)(\d)$/);
    if(!m) return null;
    const name = m[1].toUpperCase(), acc = m[2], oct = +m[3];
    const baseIndex = { C:0, D:2, E:4, F:5, G:7, A:9, B:11 }[name];
    return (oct + 1) * 12 + baseIndex + (acc === '#' ? 1 : acc === 'b' ? -1 : 0);
  }
  const midiToFreq = m => 440 * Math.pow(2, (m - 69)/12);
  const noteToFreq = n => { const m = noteToMidi(n); return m==null? null : midiToFreq(m); };

  function labelEnh(note){
    const m = note.match(/^([A-G])(#)(\d)$/);
    if(!m) return note;
    const base=m[1], oct=m[3], enh={C:'Db',D:'Eb',F:'Gb',G:'Ab',A:'Bb'};
    return `${base}#${oct} (${enh[base]}${oct})`;
  }

  // ---------- audio ----------
  let audioCtx=null, master=null;
  function getCtx(){
    if(!audioCtx){ const Ctx = window.AudioContext || window.webkitAudioContext; audioCtx = new Ctx(); }
    if(audioCtx.state==='suspended') audioCtx.resume();
    if(!master){ const g = audioCtx.createGain(); g.gain.value = 0.6; g.connect(audioCtx.destination); master=g; }
    return audioCtx;
  }
  function toMaster(n){ return n.connect(master); }

  function hiAttenBasic(freq){
    if (freq >= 4180) return 0.28;
    if (freq >= 2090) return 0.55;
    return 1.0;
  }

  function playTone(freq, dur=0.8){
    const ctx = getCtx(), now = ctx.currentTime;
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    const comp = ctx.createDynamicsCompressor();
    comp.threshold.setValueAtTime(-18, now);
    comp.knee.setValueAtTime(12, now);
    comp.ratio.setValueAtTime(6, now);
    comp.attack.setValueAtTime(0.003, now);
    comp.release.setValueAtTime(0.25, now);

    let t = Math.max(0.0001, parseFloat(vol.value));
    if (["sine","square","sawtooth","triangle"].includes(oscTypeSel.value)) t *= hiAttenBasic(freq);

    osc.type = oscTypeSel.value;
    osc.frequency.setValueAtTime(freq, now);
    gain.gain.setValueAtTime(0.0001, now);
    gain.gain.exponentialRampToValueAtTime(t, now + 0.02);
    gain.gain.exponentialRampToValueAtTime(0.0001, now + dur);

    osc.connect(gain).connect(comp); toMaster(comp);
    osc.start(now); osc.stop(now + dur + 0.05);
  }

  // Feedback mode
  const clamp=(x,a,b)=>Math.min(b,Math.max(a,x));
  const map=(x,i1,i2,o1,o2)=> o1 + (clamp(x,i1,i2)-i1)*(o2-o1)/(i2-i1);
  let fbGraph=null;
  function startFeedback(freq){
    stopFeedback(true);
    const ctx=getCtx(), now=ctx.currentTime;
    const attackMs = map(freq, 300, 3500, 14, 38);
    const Q        = map(freq, 600, 3500, 28, 20);
    const midBoost = (freq>=130 && freq<=2000) ? 2.0 : 1.0;

    const gate=ctx.createGain();
    const dc=ctx.createBiquadFilter(); dc.type='highpass'; dc.frequency.value=20;
    const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=freq; bp.Q.value=Q;
    const delay=ctx.createDelay(0.03); delay.delayTime.value=0.006;
    const fb=ctx.createGain();
    const excMix=ctx.createGain(); excMix.gain.value=1.0;

    const excOsc=ctx.createOscillator(); excOsc.type='sine'; excOsc.frequency.value=freq;
    const excGain=ctx.createGain(); excGain.gain.value=0.0001;
    const noiseGain=ctx.createGain(); noiseGain.gain.value=0.0001;

    const len=Math.floor(ctx.sampleRate*0.08);
    const nb=ctx.createBuffer(1,len,ctx.sampleRate);
    const d=nb.getChannelData(0); for(let i=0;i<len;i++){ d[i]=(Math.random()*2-1)*0.4; }
    const noise=ctx.createBufferSource(); noise.buffer=nb; noise.connect(noiseGain).connect(excMix);

    const out=ctx.createGain();
    const comp=ctx.createDynamicsCompressor();
    comp.threshold.value=-22; comp.knee.value=12; comp.ratio.value=8; comp.attack.value=0.006; comp.release.value=0.16;

    fb.gain.value=0.55;
    fb.gain.linearRampToValueAtTime(0.92, now + attackMs/1000);
    excGain.gain.linearRampToValueAtTime(0.05 * midBoost, now + (attackMs*0.8)/1000);
    noiseGain.gain.linearRampToValueAtTime(0.12 * midBoost, now + attackMs/2000);
    noiseGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.12);

    excOsc.connect(excGain).connect(excMix);
    excMix.connect(gate); gate.connect(bp); bp.connect(dc).connect(out).connect(comp); toMaster(comp);
    bp.connect(delay); delay.connect(fb); fb.connect(bp);

    const baseT = Math.min(0.35, Math.max(0.0001, parseFloat(vol.value) * 0.7));
    const tgt = Math.min(0.72, baseT * midBoost);
    gate.gain.setValueAtTime(0.0001, now);
    gate.gain.linearRampToValueAtTime(tgt, now + attackMs/1000);

    noise.start(now); noise.stop(now + 0.14);
    fbGraph = {ctx, gate, fb, excOsc, noise};
  }
  function stopFeedback(immediate=false){
    if(!fbGraph) return;
    const {ctx, gate, fb, excOsc, noise} = fbGraph; const now = ctx.currentTime;
    const rel = immediate?0.05:0.14;
    try{
      gate.gain.cancelScheduledValues(now);
      gate.gain.exponentialRampToValueAtTime(0.0001, now+rel);
      fb.gain.linearRampToValueAtTime(0.0, now+rel*0.7);
      if(noise){ try{ noise.stop(now+0.02);}catch(e){} }
      excOsc.stop(now+rel+0.02);
    }catch(e){}
    fbGraph=null;
  }

  // Pink Noise
  let pinkNode=null, pinkGain=null, pinkOn=false;
  function createPinkNode(ctx){
    const node=ctx.createScriptProcessor(1024,1,1);
    let b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0;
    node.onaudioprocess=e=>{
      const out=e.outputBuffer.getChannelData(0);
      for(let i=0;i<out.length;i++){
        const white=Math.random()*2-1;
        b0=0.99886*b0 + white*0.0555179;
        b1=0.99332*b1 + white*0.0750759;
        b2=0.96900*b2 + white*0.1538520;
        b3=0.86650*b3 + white*0.3104856;
        b4=0.55000*b4 + white*0.5329522;
        b5=-0.7616*b5 - white*0.0168980;
        const pink=b0+b1+b2+b3+b4+b5+b6 + white*0.5362; b6=white*0.115926;
        out[i]=pink*0.11;
      }
    };
    return node;
  }
  function ensurePink(){
    const ctx=getCtx();
    if(!pinkNode){ pinkNode=createPinkNode(ctx); pinkGain=ctx.createGain(); pinkGain.gain.value=0.0001; pinkNode.connect(pinkGain); toMaster(pinkGain); }
    return {ctx,pinkNode,pinkGain};
  }
  function pinkTarget(){ return Math.pow(parseFloat(vol.value), 1.2) * 0.525; }
  function pinkStart(){ const {ctx}=ensurePink(); const now=ctx.currentTime, t=pinkTarget(); pinkGain.gain.cancelScheduledValues(now); pinkGain.gain.setValueAtTime(0.0001,now); pinkGain.gain.linearRampToValueAtTime(t, now+0.02); pinkOn=true; pinkBtn.classList.add('on'); pinkBtn.setAttribute('aria-pressed','true'); }
  function pinkStop(){ if(!pinkGain) return; const ctx=getCtx(), now=ctx.currentTime; pinkGain.gain.cancelScheduledValues(now); pinkGain.gain.exponentialRampToValueAtTime(0.0001, now+0.12); pinkOn=false; pinkBtn.classList.remove('on'); pinkBtn.setAttribute('aria-pressed','false'); }
  pinkBtn.addEventListener('click', ()=> pinkOn ? pinkStop() : pinkStart());
  vol.addEventListener('input', ()=>{ if(pinkOn&&pinkGain){ const ctx=getCtx(), now=ctx.currentTime, t=pinkTarget(); pinkGain.gain.cancelScheduledValues(now); pinkGain.gain.linearRampToValueAtTime(t, now+0.05); } });

  // ---------- build keys (A0–C8) ----------
  const rangeMin = noteToMidi('A0');  // 21
  const rangeMax = noteToMidi('C8');  // 108
  function withinRange(note){ const m=noteToMidi(note); return m>=rangeMin && m<=rangeMax; }

  function addWhiteCell(container, name){
    const cell=document.createElement('div'); cell.className='cell';
    const wbtn=document.createElement('button'); wbtn.type='button'; wbtn.className='white';
    wbtn.innerHTML='<span class="wlab">'+name+'</span>';
    bindKey(wbtn, name); cell.appendChild(wbtn);

    const base = name[0];
    if(hasBlack[base]){
      const bn = sharpOf[base] + name.match(/\d+$/)[0];
      if(withinRange(bn)){
        const bbtn=document.createElement('button'); bbtn.type='button'; bbtn.className='black';
        bbtn.innerHTML='<span class="blab">'+bn+'</span>';
        bindKey(bbtn, bn); cell.appendChild(bbtn);
      }
    }
    container.appendChild(cell);
  }

  function buildFullKeyboard(){
    keysWrap.innerHTML='';

    const pre=document.createElement('div'); pre.className='oct';
    addWhiteCell(pre, 'A0'); addWhiteCell(pre, 'B0');
    keysWrap.appendChild(pre);

    for(let oct=1; oct<=7; oct++){
      const octWrap=document.createElement('div'); octWrap.className='oct';
      ['C','D','E','F','G','A','B'].forEach(letter=> addWhiteCell(octWrap, `${letter}${oct}`));
      keysWrap.appendChild(octWrap);
    }

    const last=document.createElement('div'); last.className='oct';
    addWhiteCell(last, 'C8');
    keysWrap.appendChild(last);
  }

  // ---------- drag-to-scroll ----------
  const kb = document.querySelector('.keyboard');
  let dragging=false, startX=0, startScroll=0;

  kb.addEventListener('pointerdown', e=>{
    kb.setPointerCapture(e.pointerId);
    dragging=false; startX=e.clientX; startScroll=kb.scrollLeft;
  });
  kb.addEventListener('pointermove', e=>{
    if(!kb.hasPointerCapture?.(e.pointerId)) return;
    const dx=e.clientX-startX;
    if(Math.abs(dx)>6) dragging=true;
    kb.scrollLeft = startScroll - dx;
  });
  kb.addEventListener('pointerup', e=>{
    try{ kb.releasePointerCapture(e.pointerId);}catch{}
    setTimeout(()=> dragging=false, 0);
  });

  function onPress(note){
    const hz=noteToFreq(note);
    const label = note.includes('#') ? labelEnh(note) : note;
    noteOut.textContent = label; hzOut.textContent = fmtHz(hz);
    updateHarm(hz);
    if(!togglePlay.checked || !hz) return;
    const mode=oscTypeSel.value;
    if(mode==='feedback') startFeedback(hz);
    else playTone(hz);
  }
  function onRelease(){ if(oscTypeSel.value==='feedback') stopFeedback(false); }

  function bindKey(btn, note){
    btn.addEventListener('pointerdown', e=>{
      if(dragging) return;        // ถ้ากำลังลาก ไม่ยิงเสียง
      e.preventDefault();
      onPress(note);
      // **ตัด auto-center ออกตามที่ขอ**
      const end=()=>{ onRelease(); window.removeEventListener('pointerup', end, true); window.removeEventListener('pointercancel', end, true); };
      window.addEventListener('pointerup', end, true); window.addEventListener('pointercancel', end, true);
    }, {passive:false});
  }

  function updateHarm(base){
    valSub.textContent = (toggleSub.checked && base) ? fmtHz(base/2) : '—';
    if(toggleHarm.checked && base){
      valH2.textContent=fmtHz(base*2);
      valH3.textContent=fmtHz(base*3);
      valH4.textContent=fmtHz(base*4);
    }else{
      valH2.textContent=valH3.textContent=valH4.textContent='—';
    }
  }

  // init
  buildFullKeyboard();
  updateHarm(null);
})();
</script>
</body>
</html>
